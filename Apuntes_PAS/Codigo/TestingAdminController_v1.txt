package sig.admin

import java.util.Date;

import grails.plugins.springsecurity.Secured
import sig.Persona
import sig.Lloc
import sig.TAmbit
import sig.TFamilia
import sig.Funcio
import utils.BaseControler

@Secured(['ROLE_ADMIN'])

class TestingAdminController extends BaseControler{
	
	static allowedMethods = [save: "POST", update: "POST", delete: "POST"]

    def index() {
//		println "[index]"
		redirect(action: "list", params: params)
	}
	
	def list()
	{
//		println "[list]"
		this.populateUserName()
		this.paramsMaxSet(5, 10)
		
		
		def query = {
			and {
//				eq("nombre", "nom2")
				between("pernr", 15, 60)
			}
//			maxResults(2)
//			if(params.sort!=null){
//				order(params.sort, params.order)
//			}
			//order("dni", "desc")
		}
		
		//println "params: "+params.order+"---"+params.sort
		def resultList = Persona.createCriteria().list(params,query)
		def results = resultList.getTotalCount()
		
		[personasList:resultList , funcioTotal:results]
	}
	
	def iframeList() {
		
		this.paramsMaxSet(5, 10)
		println "[iframeLlocTreball]-"+params.idNom+" "+params.idCognom1+" "+params.idCognom2
		
		//Llista amb totes les disciplines de risc, per la creació
		def funcioAmbitList = TAmbit.list()
		
		def funcioTotal =  Lloc.countByNomAndPrimerCognomAndSegonCognom( params.idNom,params.idCognom1,params.idCognom2 )
		def llocTreball = Lloc.findAllByNomAndPrimerCognomAndSegonCognom( params.idNom,params.idCognom1,params.idCognom2, [max:params.max, offset:params.offset] )
		println "lloc: " + llocTreball.descripcioLlarga
		println "TOTAL: "+llocTreball.size
		
		def mesuraInstanceList = []
		
//		for(int i =0; i<17; i++){
//			mesuraInstanceList << llocTreball[0]
//		}
		
		[llocTreball:llocTreball, funcioTotal:funcioTotal , funcioAmbitList:funcioAmbitList]

	}
	
	def iframeCreate()
	{
//		println "[iframeCreate]"+params.filtreAmbit
//		println "[iframeCreate]-"+params.idNom+" "+params.idCognom1+" "+params.idCognom2
//		println "[iframeCreate]----->"+params.idCodi+"<-"
//		
		def ambitList = TAmbit.list()
		
		def familiatList = TFamilia.list()
		
		def funciotList = Funcio.list()
//		println funciotList.descripcioLlarga
		[ambitList:ambitList , familiatList:familiatList, funcioList:funciotList]
	}
	
	
	def iframeSave(){
//		println "[iframeCreate::save]"
		//println "[iframeCreate::save]---"+params.idNom+" "+params.idCognom1+" "+params.idCognom2
		//println "[iframeCreate::save]---"+params.filtreAmbit+"---"+params.filtreFamilia+"---"+params.filtreFuncio
//		println "CODI DE CREACIÓ: "
		
		def dat = Funcio.findByCodi(params.filtreFuncio)
//		println dat.descripcioLlarga
		
		def llocTreball = new Lloc(
			//34008187	 
			codi:params.filtreCodi,
			descripcioCurta:dat.familia,
			descripcioLlarga:dat.descripcioCurta,
			primerCognom:params.idCognom1,
			segonCognom:params.idCognom2,
			nom:params.idNom,
			dataInici:new Date(),
			dataFi:new Date(),
			vigent:"S"
		 	)
		
		
		llocTreball.save(flush: true)
		
		redirect(action: "iframeList",params:params)
		
		
	}
	
	
	def iframeDelete(){
//		println "[iframeDelete]"
//		println "[iframeDelete]-d-d-"+params.idNom+" "+params.idCognom1+" "+params.idCognom2
//		println "[iframeDelete]----->"+params.idCodi+"<-"
		
		//PARA BORRAR.
		def llocTreball = Lloc.findByNomAndPrimerCognomAndSegonCognomAndCodi(params.idNom,params.idCognom1,params.idCognom2, params.idCodi)
		if(llocTreball!=null){
//			println llocTreball.codi
//			llocTreball.delete(flush: true)
		}
		
		
		redirect(action: "iframeList", params: [idNom: params.idNom, idCognom1:params.idCognom1, idCognom2:params.idCognom2])
		
	}
	
}